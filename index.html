
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ivan Voroshilin&#8217;s Blog.</title>
  <meta name="author" content="Ivan Voroshilin">

  
  <meta name="description" content="Been to long since I last blogged… Since today, I am changing the format of blogging due to these 2 reasons: The blog has moved to the new platform. &hellip;">

  
  <meta name="keywords" content="distributed, algorithm, Ivan, Voroshilin, code, google, jam, software, architecture, geek, blog, java, scala, groovy, scalability" />


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://vibneiro.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/octopress/atom.xml" rel="alternate" title="Ivan Voroshilin's Blog." type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37693662-1', 'ivoroshilin.com');
  ga('send', 'pageview');

</script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ivan Voroshilin&#8217;s Blog.</a></h1>
  
    <h2>Algorithmic contests, distributed systems and software architecture</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/octopress/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="vibneiro.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Main page</a></li>
  <li><a href="/blog/archives">All posts</a></li>
  <li><a href="/talks">Talks</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2015/06/08/researching-work-execution-with-dispatchers-in-java-8-from-naive-to-akka-like-design/">Researching Work Execution With Dispatchers in Java 8: From Naive to Akka-like Design</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-08T22:39:12+03:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:39 pm</span></time>
        
           | <a href="/2015/06/08/researching-work-execution-with-dispatchers-in-java-8-from-naive-to-akka-like-design/#disqus_thread"
             data-disqus-identifier="http://vibneiro.github.io/2015/06/08/researching-work-execution-with-dispatchers-in-java-8-from-naive-to-akka-like-design/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Been to long since I last blogged…</p>

<p>Since today, I am changing the format of blogging due to these 2 reasons:</p>

<ol>
<li><p>The blog has moved to the new platform.</p></li>
<li><p>I want to make it more lively and plausible, that is not just writing a problem statement with solutions, but describing chalenges, and the way I came up with smth. So, the text is going to be more hilarious, and easy to follow.. Will see.. ;-)</p></li>
</ol>


<p>Ok, let&rsquo;s catch up.. I’ve been wrestling with concurrent algorithms and some advanced techniques to reduce contention lately.
E.g. last month, I was researching design of <a href="https://github.com/akka/akka/tree/master/akka-actor/src/main/scala/akka/dispatch">Akka Dispatchers</a>,
advanced caching in java (in particular, a java 8 rewrite of Guava&rsquo;s <a href="https://code.google.com/p/concurrentlinkedhashmap/">ConcurrentLinkedHashMap</a> - <a href="https://github.com/ben-manes/caffeine">«Caffeine»</a>, kudos to Ben Maine for his constant help, he designed both of them btw), did some <a href="https://github.com/vibneiro/dispatching/tree/master/benchmarks-java-8">JMH benchmarks</a>.</p>

<p>My goal was to execute multiple Runnable tasks in java, coming in under a high load. Tasks with the same dispatchId should form a FIFO queue (very much like Actors in Scala and their mailboxeis) for further scheduling by a dispatcher.</p>

<p>This post came about as a small research towards squeezing out more performance from concurrent dispatching.</p>

<h2><strong>TL;DR</strong></h2>

<p>The post has a quick rundown with the main isssues and solutions for dispathcing Runnable tasks in a higly concurrent environment.. We&rsquo;re going to touch on some techniques in caching such as WeakReference-Values (I&rsquo;m going to explain below why WeakRerefence and on values, odd?), some contention reduction tricks, at lasat ending up with an Akka-like event dispatcher.</p>

<h3><strong>Intro</strong></h3>

<p>I originally started exploring hashed dispatching, but then struggled with an overall performance bottleneck..
The <a href="https://github.com/vibneiro/dispatching/blob/master/dispatch-java-8/src/main/java/vibneiro/dispatchers/ThreadBoundHashDispatcher.java">Dispatcher</a> was implemented by computing a thread of execution as a hash(dispatchId) mod threadsNumber. That is, each thread has a separate ConcurrentLinkedQueue as a FIFO buffer for scheduling. See the picture for clarity.</p>

<p><img src="https://ivoroshilin.files.wordpress.com/2014/10/threadboundhashdispatcher1.png" alt="" /></p>

<p>As turned out, the algorithm heavily degrades as a number of tasks increases due to the fact that hashing is not ideal (is not 100% uniform).</p>

<h2><strong>Unbalanced work</strong></h2>

<p>What if tasks differ in their run-time complexity? Some threads can be busy, while others are free, not helping others.
This leads, as per the above model, to the stall of some threads which is very inefficient causing unbalanced execution and performance degradation. Even though, if tasks were equal in execution time, that would be a lot less scalable  under a high contention. Such things as CPU context-switches, memory-page faults, and most importantly, thread contention on the same lock kills the overall performance.</p>

<h2><strong>Redesign</strong></h2>

<p>Some dispatchId queues may be more active than the others and unfairly balanced among workers. Thus, we need to somehow decouple taskId FIFO Queues from corresponding workers, but maintain the FIFO order for the same dispatchId. By separating the queue from the worker, we retain FIFO property and more evenly spread out the work.</p>

<p>Let&rsquo;s use a CompletableFuture (It is our FIFO-based everywhere below in the text) as a queuing mechanism backed by a ConcurrentMap&lt;dispatchId, CompletableFuture> as a simple cache. CompletableFuture refers to the next future for completion holding a FIFO property.</p>

<p><img src="https://ivoroshilin.files.wordpress.com/2014/10/wsdispatcher.png" alt="" /></p>

<h2><strong>Prunning the map</strong></h2>

<p>However, If a dispatcher always executes new unique dispatchIds, then we need to prune the cache, avoiding OutOfMem.</p>

<p>We can use WeakReference values to automatically evict, based on the observation that the execution chain provides the strong reference and completed futures become garbage. Why value, but not a key? The key isn&rsquo;t appropriate because it doesn&rsquo;t tells us when its chained CompletedFuture is done. Weak-reference values do! The value has a strong reference through the executor chaining down to the last enqueued future. When the last future completes and is idle, it becomes eligible for garbage collection and the map may evict the entry.</p>

<p>The churn rate of tasks is low in most cases. However there is a small GC penalty by delegating the tracking to WeakReference, but can be performed in a minor GC (yes, copying young GC) and aggressively cleared.</p>

<p>I derived the idea from Guava to prune the map in a separate thread, right after some threshold was hit, via exclusive tryLock – so we want block progress of other threads – neat!</p>

<p>Why not SoftReferene values? <a href="http://jeremymanson.blogspot.ru/2009/07/how-hotspot-decides-to-clear_07.html">Soft references require two major GCs</a> in order to be collected, are costly to track, and if abused can fill up the heap to cause GC thrashing. I’ve left out some details, but this is the gist of it!</p>

<p>See <a href="https://github.com/vibneiro/dispatching">the code on Github</a>.</p>

<h2><strong>Thread Pool - a big deal</strong></h2>

<p>A few words about <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ForkJoinPool.html">ForkJoinPool</a> and non-recursive tasks. Many people still tend to think that ForkJoinPool is efficient only for Recursive tasks. I <a href="http://stackoverflow.com/questions/30047122/java-forkjoinpool-with-non-recursive-tasks-does-work-stealing-work">asked this question</a> a while ago on stackoverflow and even had to ask Alexey Shipilev to step in. :-) Why does <a href="http://akka.io/">Akka</a> use ForkJoinPool as the main engine of task execution? Or why does JDK 8 takes advantage of a commonPool() in its Streaming and CompletedFuture implementations?
Becasuse, for highly-intensive short tasks, which don&rsquo;t involve heavy I/O, they are way more scalable, unlike e.g. FixedThreadPool!</p>

<p>Here&rsquo;s <a href="https://github.com/vibneiro/dispatching">the difference</a> in these performance JMH benchmarks of ThreadPoolExecutor and ForkJoinPool.
Tasks are already small and needn&rsquo;t a recursive decomposition. Work-stealing works (read the design of ForkJoinPool if confused), regardless whether it is a big or small task - tasks can be grabbed by another free worker from the Deque&rsquo;s tail of a busy worker, reducing contention.</p>

<h2><strong>Actor-like dispatchers</strong></h2>

<p>I was reluctant to write my own, as the Caffeine has already <a href="https://github.com/ben-manes/caffeine/blob/master/jcache/src/main/java/com/github/benmanes/caffeine/jcache/event/EventDispatcher.java">one</a>.</p>

<p>By the way! Here&rsquo;s <a href="https://github.com/vibneiro/dispatching/blob/master/dispatch-java-7/src/main/java/vibneiro/dispatchers/WorkStealingDispatcher.java">a backport of the java 8 Dispatcher to JDK 7</a> translated with Guava&rsquo;s ListenableFuture into Java 7 code.</p>

<h2><strong>A few words about Caffeine</strong></h2>

<p>I chatted with Ben Maine via email regarding Caffeine&rsquo;s cache design under the hood. There are advanced mechanics (e.g. eventually-consistent multithreaded datastructures, Stripe64 and full rewrite of ConcurrentHashMap proves to be very efficient)! It was fun to make some research&hellip;</p>

<h2><strong>Conclusion</strong></h2>

<p>Later, I decided to use the Caffeine in my Dispatcher, because it yielded very good results on the majority of <a href="https://github.com/vibneiro/dispatching">JMH performance benchmarks</a> compared to my implementations under similar parameters, including weak-values.
I decided not to remove ![ThreadBoundHashDispatcher](<a href="https://github.com/vibneiro/dispatching/blob/master/dispatch-java-8/src/main/java/vibneiro/dispatchers/ThreadBoundHashDispatcher.java">https://github.com/vibneiro/dispatching/blob/master/dispatch-java-8/src/main/java/vibneiro/dispatchers/ThreadBoundHashDispatcher.java</a>( from the code though, as one might potentially have some benefits for some rare cases.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2015/03/13/migrated-to-octopress/">The Blog Has Migrated to a New Platform</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-13T02:25:26+03:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:25 am</span></time>
        
           | <a href="/2015/03/13/migrated-to-octopress/#disqus_thread"
             data-disqus-identifier="http://vibneiro.github.io/2015/03/13/migrated-to-octopress/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The site has some syntax errors due to migration. This is going to be fixed soon.
My apologies for inconvenience.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2015/02/05/toughest-backtracking-problems-in-algorithmic-competitions/">Toughest Backtracking Problems in Algorithmic Competitions</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-05T14:53:05+03:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:53 pm</span></time>
        
           | <a href="/2015/02/05/toughest-backtracking-problems-in-algorithmic-competitions/#disqus_thread"
             data-disqus-identifier="http://vibneiro.github.io/2015/02/05/toughest-backtracking-problems-in-algorithmic-competitions/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://ivoroshilin.files.wordpress.com/2015/02/backtrack.png"><img src="https://ivoroshilin.files.wordpress.com/2015/02/backtrack.png" alt="backtrack" /></a></p>

<h2><strong>TL;DR</strong></h2>

<p>In algorithmic competitions there are frequently problems that can be attacked with <a href="//en.wikipedia.org/wiki/Maze_generation_algorithm">recursive backtracking algorithms</a>) - a well-known approach to traverse <a href="//en.wikipedia.org/wiki/Depth-first_search">a search tree</a>). Usually, it is good smell, if there&rsquo;s a goal to analyze all existing combinations of a problem. And, of course, there needs to be the right strategy to meet time limits (e.g. prune it). Here, I&rsquo;ve decided to talk about a few very interesting backtracking problems I came across. I touch on a backtracking approach to develop in competitors, but bear in mind that, not trying to solve a problem by yourself, seeing the answer up front is a waste of time. Furthermore, this is an advanced level, if you haven&rsquo;t practiced a recursive backtracking or DFS, please spend some time on basic backtracking problems and come back.</p>

<h3><strong>1. Chess Puzzler</strong></h3>

<p><a href="https://ivoroshilin.files.wordpress.com/2015/02/chess.jpg"><img src="https://ivoroshilin.files.wordpress.com/2015/02/chess.jpg?w=300" alt="chess" /></a></p>

<p>This is quite an interesting problem I&rsquo;ve ever come across, solving it you realize some very important uses cases to consider like memory limits, recursion, combinatorics and optimization techniques. I&rsquo;ve seen a chess problem in Skiena&rsquo;s  algorithmic book some time ago, but as turned out, this one is very different.</p>

<h4><strong>Problem Statement:</strong></h4>

<p>The problem is to find all distinct layouts of a set of normal chess pieces on a chess board with dimensions MxN where none of the pieces is in a position to take any of the others. Assume the color of the piece does not matter, and that there are no pawns among the pieces.</p>

<p>Write a program which takes as input:</p>

<ul>
<li><p>  The dimensions of the board: M, N.</p></li>
<li><p>  The number of pieces of each type (King, Queen, Bishop, Rook and Knight) to try and place on the board.</p></li>
</ul>


<p>As output, the program should yield the number of distinct layouts for which all of the pieces can be placed on the board without threatening each other.</p>

<h4><strong>Solution:</strong></h4>

<p>We represent each piece as: &ldquo;K&rdquo; - King &ldquo;N&rdquo; - Knight &ldquo;Q&rdquo; - Queen &ldquo;R&rdquo; - Rook &ldquo;B&rdquo; - Bishop M - Horizontal size of the board N - Vertical size of the board S - is a set of remaining pieces. For example: Input: 3×3 board containing 2 Kings and 1 Rook, that is S = [K,K,R]. Answer: 4 layouts.</p>

<p><a href="https://ivoroshilin.files.wordpress.com/2015/02/layouts.png"><img src="https://ivoroshilin.files.wordpress.com/2015/02/layouts.png?w=300" alt="layouts" /></a></p>

<p>Since we need to find all possible layouts of a chessboard, it can be solved with a recursive backtracking as follows. We take the next piece from S and calculate for it all possible freeSquares on the chess board. Next, by iterating in a loop over freeSquares for current piece, we try to put it in all possible freeSquares. Each loop-step is a potential solution (layout) calls itself recursively by trying to put the next piece for current chess board and so forth until there are no pieces left or freeSquares is empty. Once a piece is placed on the board, we update the set of the free squares by subtracting a set of squares threatened by this piece. In case the set of free squares is empty and there are still any remaining pieces not on the board, there&rsquo;s no solution to this combination and the recursive function backtracks to the upper level in the recursive tree trying the next loop-step. Thereby, we loop over all steps and stop traversing by pruning impossible configuration in advance - as simple as this. There could be some arithmetic optimization with a number of threatened squares for each piece type by taking into account all remaining pieces to be put on the board and number of free squares, calculated in one go. Since the time limit in this problem was 20 mins to solve, I ditched an optimization. Undoubtedly, my solution can be drastically improved by cutting the search tree even more, and hence I leave this to the reader. Moreover you might want to parallelize this recursive task.</p>

<p>Finishing touch, namely what to do about duplicated pieces like 3 queens or 2 knights etc. Honestly, I spent a great deal of time on this while solving. The thing is that, duplicates are interchangeable in terms of different combinations on the chessboard. For instance, for a board of 1x2 length with free squares [x:1,y:1][x:1,y:2], 2 queens can be placed as [Q1][Q2] or [Q2][Q1] yielding 2 different combinations. A simple solution is to put at once all pieces of one type inside a loop-step. From combinatorics, we can enumerate all C(n, k) unique combinations (aka n choose k) in a single loop. Because we recurse, I created a <a href="https://github.com/vibneiro/Combinatorics/blob/master/Combinations.groovy">utility function</a> wrapped around with a standard java iterator which doesn&rsquo;t have to calculate all combinations up front, rather it traverses them lazily by calculating the next one on the fly. The reason for this was a memory taken on each level of the recursion stack to keep an array of all combinations. E.g. C(n, k) = C(1000,5) results into 8,250,291,250,200 elements. There were also some minor issues with Groovy not being able to correctly calculate a difference between 2 lists of coordinate-pairs. Thanks to guys on <a href="http://stackoverflow.com/">stackoverflow </a>who quickly replied with a <a href="http://stackoverflow.com/questions/27216832/groovy-language-how-to-get-difference-between-two-lists-of-pairs">workaround</a>. The full working code  is now available on <a href="https://github.com/vibneiro/ChessBoardSolver">GitHub</a>. If somebody of you have an idea to optimize it somehow, please comment one at the end of this post!</p>

<h3><strong>2. To backtrack or not, that&rsquo;s the question: Meet &ldquo;Mine Sweeper Master&rdquo; from Google code jam 2014</strong></h3>

<p><a href="https://ivoroshilin.files.wordpress.com/2015/02/minesweeper.png"><img src="https://ivoroshilin.files.wordpress.com/2015/02/minesweeper.png" alt="minesweeper" /></a></p>

<p>A tricky and simple at the same time problem was posed last year on Google Code Jam in qualification round - a famous <a href="https://code.google.com/codejam/contest/2974486/dashboard#s=p2">Mine Sweeper master</a>. Yes, the one that comes with Windows operating system - I bet, most of you are aware of! It&rsquo;s well-known solving minesweeper is<strong> NP-complete.</strong> But conditions of the problem don&rsquo;t require you to do that (Please read a problem statement before proceeding).</p>

<p>Solving it with a backtracking is the wrong way, as you are not required to analyze all configurations. The catch is that any correct result is a solution (read carefully a problem  statement)! And thus, you don&rsquo;t have to attack it with backtracking as this pattern is quite costly, aimed at getting all possible solutions. It is possible, but you won&rsquo;t pass the large set most likely. Hence, the simplest idea is to start at (0,0) - upper-left corner and fill an area of <code>N</code> cells  with non-mine space from left to right and top to bottom - line-by-line. Further, fill the rest with mines. Clicking the (0,0) cell should reveal if this is a good solution. If (0,0) is not a mine - we have won. If the square contains a 0, repeat this recursively for all the surrounding squares.</p>

<p>There are also a number of important corner cases to consider for this approach:</p>

<p><strong>Single non-mine</strong></p>

<p>If <code>N=1</code>, any configuration is a correct solution.</p>

<p><strong>Single row or single column</strong></p>

<pre><code>If &lt;code&gt;R=1&lt;/code&gt;, simply fill in the &lt;code&gt;N&lt;/code&gt; non-mines from left-to-right. If &lt;code&gt;C=1&lt;/code&gt;, fill &lt;code&gt;N&lt;/code&gt; rows with a (single) non-mine.
</code></pre>

<p><strong>Too few non-mines</strong></p>

<pre><code>If &lt;code&gt;N&lt;/code&gt; is even, it must be &gt;= 4. 
If &lt;code&gt;N&lt;/code&gt; is odd, it must be &gt;= 9. Also, &lt;code&gt;R&lt;/code&gt; and &lt;code&gt;C&lt;/code&gt; must be &gt;= 3.

Otherwise there's no solution.
</code></pre>

<p><strong>Can&rsquo;t fill first two rows</strong></p>

<pre><code>If &lt;code&gt;N&lt;/code&gt; is even and you can't fill at least two rows with non-mines, then fill the first two rows with &lt;code&gt;N / 2&lt;/code&gt; non-mines.   
If &lt;code&gt;N&lt;/code&gt; is odd and you can't fill at least two rows with non-mines and a third row with 3 non-mines, then fill the first two rows with &lt;code&gt;(N - 3) / 2&lt;/code&gt; non-mines and the third row with 3 non-mines.
</code></pre>

<p><strong>Single non-mine in the last row</strong></p>

<pre><code>If &lt;code&gt;N % C = 1&lt;/code&gt;, move the final non-mine from the last full row to the next row.
</code></pre>

<p>I was lazy to depict each one. As can be seen, there is bunch of special cases to consider to make this solution pass.</p>

<h3><strong>3. Another Chess Board Puzzler: &ldquo;King&rdquo; from Google Code Jam 2008</strong></h3>

<p>This is one of the toughest<a href="http://code.google.com/codejam/contest/32008/dashboard#s=p3"> problem</a>s from Google Code Jam. It differs in that <strong>no one solved it</strong> in global Code Jam rounds during the round in which it was posed. Algorithmic competitions is like sports, if you feel you can solve easier problems faster - go for it. Otherwise you&rsquo;re at risk of loosing the competition. Some day next time I will try to attack it too, and for now I say goodbye to  all of you.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/12/16/docker-creating-and-testing-httprest-server-on-top-of-akkaspray/">Dockerizing Spray HTTP Server</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-16T01:22:04+03:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:22 am</span></time>
        
           | <a href="/2014/12/16/docker-creating-and-testing-httprest-server-on-top-of-akkaspray/#disqus_thread"
             data-disqus-identifier="http://vibneiro.github.io/2014/12/16/docker-creating-and-testing-httprest-server-on-top-of-akkaspray/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://ivoroshilin.files.wordpress.com/2014/10/docker.png"><img src="https://ivoroshilin.files.wordpress.com/2014/10/docker.png" alt="docker" /></a><a href="https://ivoroshilin.files.wordpress.com/2014/12/spray.png"><img src="https://ivoroshilin.files.wordpress.com/2014/12/spray.png" alt="spray" /></a></p>

<p>This is the continuation of the <a href="http://ivoroshilin.com/2014/10/30/docker-a-birds-eye-view/">previous article</a>. This series shows how simple it is to create a lightweight HTTP-server based on <a href="http://spray.io">Spray</a> framework, put it into a <a href="https://docs.docker.com">Docker</a>-image and run multiple instances on any single machine requiring no dependencies.</p>

<h3>Implementing a lightweight RESTful HTTP Service</h3>

<p>The whole project can be found on <a href="https://github.com/vibneiro/DockerSprayHttpServer">GitHub</a>. For impatient, git pull it and jump right to the next section. We&rsquo;re going to use Scala and Akka framework along with <a href="http://www.scala-sbt.org">SBT</a> build tool. From Spray framework we will use a <a href="http://spray.io/documentation/1.1-SNAPSHOT/spray-routing/">spray-routing</a> module which has a simple routing DSL for elegantly defining RESTful web services and it works on top of a <a href="http://spray.io/documentation/1.1-SNAPSHOT/spray-can/#spray-can">spray-can HTTP Server</a><em>.</em></p>

<p>Ok, let&rsquo;s get started.</p>

<p>[code language=&ldquo;scala&rdquo;]
import akka.actor.{ActorSystem}
import spray.routing.<em>
import akka.util.Timeout
import scala.concurrent.duration.</em>
import scala.util.{Failure, Success}</p>

<p>object HttpServer extends App with SimpleRoutingApp {</p>

<p>  implicit val actorSystem = ActorSystem()
  implicit val timeout = Timeout(1.second)
  import actorSystem.dispatcher</p>

<p>  startServer(interface = &ldquo;localhost&rdquo;, port = 8080) {</p>

<pre><code>// GET /welcome --&gt; "Welcome!" response
get {
  path("welcome") {
    complete {
      &lt;html&gt;
        &lt;h1&gt;"Welcome!&lt;/h1&gt;
        &lt;p&gt;&lt;a href="/terminate?method=post"&gt;Stop the server&lt;/a&gt;&lt;/p&gt;
      &lt;/html&gt;
    }
  }
} ~
  // POST /terminate --&gt; "The server is stopping" response
  (post | parameter('method ! "post")) {
    path("terminate") {
      complete {
        actorSystem.scheduler.scheduleOnce(1.second)(actorSystem.shutdown())(actorSystem.dispatcher)
        "The server is stopping"
      }
    }
  }
</code></pre>

<p>  }
    .onComplete {
    case Success(b) =>
      println(&ldquo;Successfully started&rdquo;)
    case Failure(ex) =>
      println(ex.getMessage)
      actorSystem.shutdown()
  }
}
[/code]</p>

<p>The REST API is as follows:</p>

<ul>
<li><p>GET/welcome &ndash;> responds with a &ldquo;Welcome&rdquo; and Post-hyperlink.</p></li>
<li><p>POST/terminate &ndash;> will stop the server.</p></li>
</ul>


<p>DSL describing this API is inside of a method <strong>startServer.  </strong>And that&rsquo;s it!</p>

<p>I didn&rsquo;t want to show the full power of Spray because this article is solely about Docker.</p>

<p>Let&rsquo;s run it and check:</p>

<p>[code language=&ldquo;bash&rdquo;]
curl <a href="http://localhost:8080/welcome">http://localhost:8080/welcome</a>
[/code]</p>

<h3>Dockerizing the server</h3>

<p>Because the Docker Engine uses Linux-specific kernel features, I&rsquo;m going to use <a href="https://docs.docker.com/installation/mac/">lightweight virtual machine</a> to run it on OS X. If you too, just download it, install and run - easy peasy. Just make sure before dockerizing that you&rsquo;ve set the following 3 env variables for connecting your client to the VM:</p>

<p>[code language=&ldquo;bash&rdquo;]
export DOCKER_HOST=tcp://192.168.59.103:2376
export DOCKER_CERT_PATH=/Users/ivan/.boot2docker/certs/boot2docker-vm
export DOCKER_TLS_VERIFY=1
[/code]</p>

<p>The remaining stuff doesn&rsquo;t differ much.</p>

<p>We use a <a href="https://registry.hub.docker.com/u/dockerfile/java/">trusted automated java build</a> (OpenJDK Java 7 JRE Dockerfile) as a base of our image.</p>

<p>First, you will need to create a Dockerfile for the image in your project:</p>

<pre><code># Our base image
FROM dockerfile/java

WORKDIR /

USER daemon

# Here the stuff that we're going to place into the image
ADD target/scala-2.11/docker-spray-http-server-assembly-1.0.jar /app/server.jar

# entry jar to be run in a container
ENTRYPOINT [ "java", "-jar", "/app/server.jar" ]

# HTTP port
EXPOSE 8080
</code></pre>

<p>Build your project as a single jar file:</p>

<p>[code language=&ldquo;bash&rdquo;]
DockerSprayHttpServer$ sbt assembly
[/code]</p>

<p>And now navigate to the project&rsquo;s folder and run:</p>

<p>[code language=&ldquo;bash&rdquo;]
DockerSprayHttpServer$ docker build .
[/code]</p>

<p>This will send the newly created image to the Docker daemon.</p>

<h3>Running multiple instances on a single machine</h3>

<p>Run the following command to see available docker images :</p>

<p>[code language=&ldquo;bash&rdquo;]
DockerSprayHttpServer$ docker images
[/code]</p>

<p><a href="https://ivoroshilin.files.wordpress.com/2014/12/d181d0bdd0b8d0bcd0bed0ba-d18dd0bad180d0b0d0bdd0b0-2014-12-15-d0b2-23-48-52.png"><img src="https://ivoroshilin.files.wordpress.com/2014/12/d181d0bdd0b8d0bcd0bed0ba-d18dd0bad180d0b0d0bdd0b0-2014-12-15-d0b2-23-48-52.png" alt="Снимок экрана 2014-12-15 в 23.48.52" /></a></p>

<p>a83cda03f529 is not in the repo yet - what we&rsquo;ve just created. We&rsquo;re going to run multiple instances from it.</p>

<p>First run the 1-st instance:</p>

<p>[code language=&ldquo;bash&rdquo;]
DockerSprayHttpServer$ docker run -d -p 10001:8080 a83cda03f529
[/code]</p>

<p>Note, that we have mapped our 8080&ndash;>10001 port.</p>

<p>Now, let&rsquo;s verify the container is running:</p>

<p>[code language=&ldquo;bash&rdquo;]
DockerSprayHttpServer$ docker ps
[/code]</p>

<p><a href="https://ivoroshilin.files.wordpress.com/2014/12/d181d0bdd0b8d0bcd0bed0ba-d18dd0bad180d0b0d0bdd0b0-2014-12-16-d0b2-0-58-12.png"><img src="https://ivoroshilin.files.wordpress.com/2014/12/d181d0bdd0b8d0bcd0bed0ba-d18dd0bad180d0b0d0bdd0b0-2014-12-16-d0b2-0-58-12.png" alt="Снимок экрана 2014-12-16 в 0.58.12" /></a></p>

<p>We exposed port 8080 for the http-server. When run in Docker-container, it maps our port onto another. On top of this I am  on OS X. Do you remember we set at the beginning 3 env vars? One of them is DOCKER_HOST.</p>

<p>You can actually check this IP as follows:</p>

<p>[code language=&ldquo;bash&rdquo;]
DockerSprayHttpServer$ boot2docker ip
[/code]</p>

<p>We need to use this IP address (for OS X, as we are not on Linux).</p>

<p>Let&rsquo;s test it:</p>

<p>[code language=&ldquo;bash&rdquo;]
DockerSprayHttpServer$ curl $(boot2docker ip):10001/welcome
[/code]</p>

<p>Great!</p>

<p>You can run as many containers as you want! They are completely isolated. For Scala developers, by they way, I&rsquo;ve found a<a href="https://github.com/marcuslonnberg/sbt-docker"> nice contribution</a>, you can dockerize your artifacts right from SBT.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Welcome to my blog</h1>
  <script src="//about.me/embed/ivan_voroshilin?headline=0"></script>

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2015/06/08/researching-work-execution-with-dispatchers-in-java-8-from-naive-to-akka-like-design/">Researching Work Execution With Dispatchers in Java 8: From Naive to Akka-like Design</a>
      </li>
    
      <li class="post">
        <a href="/2015/03/13/migrated-to-octopress/">The Blog Has Migrated to a New Platform</a>
      </li>
    
      <li class="post">
        <a href="/2015/02/05/toughest-backtracking-problems-in-algorithmic-competitions/">Toughest Backtracking Problems in Algorithmic Competitions</a>
      </li>
    
      <li class="post">
        <a href="/2014/12/16/docker-creating-and-testing-httprest-server-on-top-of-akkaspray/">Dockerizing Spray HTTP Server</a>
      </li>
    
      <li class="post">
        <a href="/2014/10/30/docker-a-birds-eye-view/">Docker: A Bird&#8217;s-eye View</a>
      </li>
    
      <li class="post">
        <a href="/2014/10/12/the-flip-side-of-rule-engines-and-some-tips-on-when-not-use-ones/">The Flip Side of Rule Engines on Example of Drools and Some Valuable Tips</a>
      </li>
    
      <li class="post">
        <a href="/2014/09/15/project-euler-a-list-of-interesting-problems/">Project Euler: A List of Interesting Problems</a>
      </li>
    
      <li class="post">
        <a href="/2014/08/14/command-and-query-responsibility-segregation-and-event-sourcing-what-you-should-think-about-in-advance/">Command and Query Responsibility Segregation and Event Sourcing: What You Should Think About in Advance</a>
      </li>
    
      <li class="post">
        <a href="/2014/03/18/distributed-transactions-and-scalability-issues-in-large-scale-distributed-systems/">Distributed Transactions and Scalability Issues in Large-scale Distributed Systems</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/17/service-discovery-in-distributed-systems/">Service Discovery in Distributed Systems</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'vibneiro',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Ivan Voroshilin
</p>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37693662-1', 'ivoroshilin.com');
  ga('send', 'pageview');

</script>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'vibneiro';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>









<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37693662-1', 'ivoroshilin.com');
  ga('send', 'pageview');

</script>






</body>
</html>
